<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="no-referrer">
    
    <title>NEXUS | RED OPS TERMINAL</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- CONFIG -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        red: {
                            500: '#ff0033',
                            600: '#cc0029',
                            900: '#33000a'
                        },
                        black: '#000000',
                        gray: {
                            800: '#111111',
                            900: '#0a0a0a'
                        }
                    },
                    fontFamily: {
                        sans: ['Share Tech Mono', 'monospace'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #000; 
            color: #ccc; 
            font-family: 'Share Tech Mono', monospace; 
            overflow: hidden; 
        }
        
        /* CRT Effect */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 50;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
        }
        .glow-text { text-shadow: 0 0 10px rgba(255, 0, 51, 0.7); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #33000a; border: 1px solid #ff0033; }

        /* Syntax */
        pre { background: #050505 !important; border-left: 2px solid #ff0033; padding: 1rem !important; }
        code { font-family: 'JetBrains Mono', monospace !important; font-size: 0.8em; }

        /* Loader */
        .hacker-loader span {
            display: inline-block; width: 5px; height: 15px; background: #ff0033; margin: 0 1px;
            animation: stretch 1s infinite ease-in-out;
        }
        .hacker-loader span:nth-child(2) { animation-delay: 0.1s; }
        .hacker-loader span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes stretch { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(2); } }

        /* Fullscreen mode */
        .fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            #chat-stream { padding: 0.75rem; }
            .message-user, .message-assistant { max-width: 95% !important; }
            #input-area { padding: 0.5rem; }
            #user-input { font-size: 14px; }
            .quick-actions button { font-size: 10px; padding: 0.5rem; }
        }

        /* History sidebar */
        .history-sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: #000;
            border-left: 1px solid #ff0033;
            transition: right 0.3s ease;
            z-index: 60;
            overflow-y: auto;
        }
        .history-sidebar.open { right: 0; }

        .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid #33000a;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover {
            background: #33000a;
            border-left: 2px solid #ff0033;
        }

        /* Upload progress */
        .upload-progress {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            height: 3px;
            background: #33000a;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: #ff0033;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="scanlines"></div>

    <!-- SETTINGS OVERLAY -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/95 backdrop-blur">
        <div class="border border-red-500 bg-black p-6 md:p-8 w-[95%] md:w-[500px] max-w-full shadow-[0_0_50px_rgba(255,0,51,0.2)]">
            <h2 class="text-lg md:text-xl text-red-500 mb-6 font-bold border-b border-red-900 pb-2">/// SYSTEM CONFIG</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-red-600 uppercase">HuggingFace Token (Write Access)</label>
                    <input type="password" id="hf-key" class="w-full bg-gray-900 border border-red-900 text-red-500 p-2 text-sm focus:border-red-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-red-600 uppercase">Model ID</label>
                    <input type="text" id="hf-model" value="Qwen/Qwen2.5-72B-Instruct" class="w-full bg-gray-900 border border-red-900 text-gray-400 p-2 text-sm focus:border-red-500 outline-none">
                    <p class="text-[10px] text-gray-600 mt-1">Recomendado: Qwen2.5-72B ou Mistral-Large-Instruct</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-red-900/20 border border-red-500 text-red-500 hover:bg-red-500 hover:text-black py-2 font-bold transition-all uppercase tracking-widest mt-4">
                    [ INITIATE CONNECTION ]
                </button>
            </div>
        </div>
    </div>

    <!-- HISTORY SIDEBAR -->
    <div id="history-sidebar" class="history-sidebar">
        <div class="p-4 border-b border-red-900">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-red-500 font-bold text-sm">HISTÓRICO</h3>
                <button onclick="toggleHistory()" class="text-gray-500 hover:text-red-500">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <button onclick="startNewChat()" class="w-full bg-red-900/20 border border-red-500 text-red-500 hover:bg-red-500 hover:text-black py-2 text-xs font-bold transition-all">
                + NOVA CONVERSA
            </button>
        </div>
        <div id="history-list" class="p-2">
            <!-- History items will be inserted here -->
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-12 md:h-14 border-b border-red-900/30 bg-black flex items-center justify-between px-3 md:px-4 z-40">
        <div class="flex items-center gap-2 md:gap-3">
            <i class="fa-solid fa-biohazard text-red-500 animate-pulse-fast text-sm md:text-base"></i>
            <h1 class="text-sm md:text-lg font-bold text-gray-300 tracking-[2px] md:tracking-[3px]">NEXUS <span class="text-red-500 glow-text">RED_OPS</span></h1>
        </div>
        <div class="flex items-center gap-2 md:gap-4 text-xs">
            <div id="status" class="hidden md:block text-gray-600">DISCONNECTED</div>
            <button onclick="toggleHistory()" class="text-red-500 hover:text-white" title="Histórico">
                <i class="fa-solid fa-history"></i>
            </button>
            <button onclick="toggleFullscreen()" class="text-red-500 hover:text-white" title="Fullscreen">
                <i class="fa-solid fa-expand"></i>
            </button>
            <button onclick="toggleSettings()" class="text-red-500 hover:text-white" title="Configurações">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- TERMINAL OUTPUT -->
    <main id="chat-stream" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-4 md:space-y-6 scroll-smooth pb-24 md:pb-32">
        <div id="welcome" class="mt-10 md:mt-20 text-center opacity-80">
            <i class="fa-solid fa-skull text-4xl md:text-6xl text-red-900 mb-4"></i>
            <h2 class="text-xl md:text-2xl text-red-500 font-bold mb-2">UNRESTRICTED AUDIT MODE</h2>
            <p class="text-gray-500 text-xs md:text-sm max-w-md mx-auto mb-6 md:mb-8 px-4">
                Sistema pronto para análise estática de código (SAST), geração de payloads e identificação de vetores de ataque.
            </p>
            <div class="quick-actions flex flex-col md:flex-row gap-2 md:gap-0 md:inline-flex border border-red-900 md:divide-x divide-red-900 mx-4">
                <button onclick="quickPrompt('Gere uma lista de payloads SQL Injection avançados para bypass de WAF.')" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-gray-400 hover:text-red-500 transition-colors">SQLi Payloads</button>
                <button onclick="quickPrompt('Crie um script Python para brute-force de diretórios usando threads.')" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-gray-400 hover:text-red-500 transition-colors">Brute Force Tool</button>
                <button onclick="document.getElementById('file-upload').click()" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-red-500 font-bold hover:text-white transition-colors bg-red-900/10">
                    <i class="fa-solid fa-upload mr-2"></i> ANALISAR ARQUIVO
                </button>
            </div>
        </div>
    </main>

    <!-- INPUT AREA -->
    <div id="input-area" class="fixed bottom-0 w-full bg-black border-t border-red-900/50 p-3 md:p-4 z-50">
        
        <!-- HIDDEN FILE INPUT -->
        <input type="file" id="file-upload" class="hidden" accept="*" onchange="handleFileUpload(this)">

        <!-- UPLOAD PROGRESS -->
        <div id="upload-progress" class="upload-progress hidden">
            <div id="upload-progress-bar" class="upload-progress-bar"></div>
        </div>

        <!-- UPLOAD INDICATOR -->
        <div id="upload-preview" class="hidden absolute top-[-35px] md:top-[-40px] left-3 md:left-4 bg-gray-900 border border-red-500 text-red-500 px-2 md:px-3 py-1 text-xs items-center gap-2">
            <i class="fa-solid fa-file-code"></i> <span id="filename-display">file.php</span>
            <span id="filesize-display" class="text-gray-600 ml-2"></span>
            <button onclick="clearUpload()" class="hover:text-white ml-2">×</button>
        </div>

        <div class="relative max-w-5xl mx-auto flex items-end gap-2">
            <button onclick="document.getElementById('file-upload').click()" class="h-9 w-9 md:h-10 md:w-10 border border-red-900 text-red-900 hover:border-red-500 hover:text-red-500 transition-all flex items-center justify-center bg-gray-900/50" title="Carregar Arquivo (até 1MB)">
                <i class="fa-solid fa-paperclip text-sm"></i>
            </button>
            
            <div class="flex-1 relative">
                <textarea 
                    id="user-input" 
                    placeholder="Enter command..." 
                    class="w-full bg-gray-900 border border-red-900 text-gray-300 p-2 md:p-3 resize-none focus:border-red-500 outline-none text-sm md:text-base font-mono max-h-32 overflow-y-auto"
                    rows="1"
                    onkeydown="handleKeyPress(event)"
                    oninput="autoResize(this)"
                ></textarea>
            </div>
            
            <button onclick="sendMessage()" class="h-9 w-9 md:h-10 md:w-10 bg-red-900/20 border border-red-500 text-red-500 hover:bg-red-500 hover:text-black transition-all flex items-center justify-center font-bold">
                <i class="fa-solid fa-terminal"></i>
            </button>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let API_KEY = localStorage.getItem('nexus_api_key') || '';
        let MODEL = localStorage.getItem('nexus_model') || 'Qwen/Qwen2.5-72B-Instruct';
        let history = [];
        let pendingFileContent = null;
        let pendingFileName = null;
        let currentChatId = null;
        let isFullscreen = false;

        // Initialize
        if (API_KEY) {
            document.getElementById('hf-key').value = API_KEY;
            document.getElementById('status').innerText = 'CONNECTED';
            document.getElementById('status').classList.remove('text-gray-600');
            document.getElementById('status').classList.add('text-green-500');
        }
        document.getElementById('hf-model').value = MODEL;

        // Load chat history on start
        loadHistoryList();
        
        // Load last chat if exists
        const lastChatId = localStorage.getItem('nexus_last_chat');
        if (lastChatId) {
            loadChat(lastChatId);
        }

        // --- SETTINGS ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
        }

        function saveSettings() {
            const key = document.getElementById('hf-key').value.trim();
            const model = document.getElementById('hf-model').value.trim();
            
            if (!key) {
                alert('Por favor, insira um token válido da HuggingFace.');
                return;
            }
            
            API_KEY = key;
            MODEL = model;
            localStorage.setItem('nexus_api_key', key);
            localStorage.setItem('nexus_model', model);
            
            document.getElementById('status').innerText = 'CONNECTED';
            document.getElementById('status').classList.remove('text-gray-600');
            document.getElementById('status').classList.add('text-green-500');
            toggleSettings();
        }

        // --- FULLSCREEN ---
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const body = document.body;
            
            if (isFullscreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // --- HISTORY MANAGEMENT ---
        function toggleHistory() {
            const sidebar = document.getElementById('history-sidebar');
            sidebar.classList.toggle('open');
        }

        function startNewChat() {
            currentChatId = null;
            history = [];
            document.getElementById('chat-stream').innerHTML = `
                <div id="welcome" class="mt-10 md:mt-20 text-center opacity-80">
                    <i class="fa-solid fa-skull text-4xl md:text-6xl text-red-900 mb-4"></i>
                    <h2 class="text-xl md:text-2xl text-red-500 font-bold mb-2">UNRESTRICTED AUDIT MODE</h2>
                    <p class="text-gray-500 text-xs md:text-sm max-w-md mx-auto mb-6 md:mb-8 px-4">
                        Sistema pronto para análise estática de código (SAST), geração de payloads e identificação de vetores de ataque.
                    </p>
                    <div class="quick-actions flex flex-col md:flex-row gap-2 md:gap-0 md:inline-flex border border-red-900 md:divide-x divide-red-900 mx-4">
                        <button onclick="quickPrompt('Gere uma lista de payloads SQL Injection avançados para bypass de WAF.')" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-gray-400 hover:text-red-500 transition-colors">SQLi Payloads</button>
                        <button onclick="quickPrompt('Crie um script Python para brute-force de diretórios usando threads.')" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-gray-400 hover:text-red-500 transition-colors">Brute Force Tool</button>
                        <button onclick="document.getElementById('file-upload').click()" class="px-3 md:px-4 py-2 hover:bg-red-900/20 text-xs text-red-500 font-bold hover:text-white transition-colors bg-red-900/10">
                            <i class="fa-solid fa-upload mr-2"></i> ANALISAR ARQUIVO
                        </button>
                    </div>
                </div>
            `;
            toggleHistory();
        }

        function saveCurrentChat() {
            if (history.length === 0) return;
            
            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
            }
            
            const firstUserMsg = history.find(m => m.role === 'user');
            const title = firstUserMsg ? firstUserMsg.content.substring(0, 50) : 'Nova conversa';
            
            const chatData = {
                id: currentChatId,
                title: title,
                timestamp: Date.now(),
                messages: history
            };
            
            localStorage.setItem(currentChatId, JSON.stringify(chatData));
            localStorage.setItem('nexus_last_chat', currentChatId);
            loadHistoryList();
        }

        function loadHistoryList() {
            const historyList = document.getElementById('history-list');
            const chats = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('chat_')) {
                    try {
                        const chat = JSON.parse(localStorage.getItem(key));
                        chats.push(chat);
                    } catch (e) {}
                }
            }
            
            chats.sort((a, b) => b.timestamp - a.timestamp);
            
            historyList.innerHTML = chats.length === 0 
                ? '<div class="text-center text-gray-600 text-xs p-4">Nenhuma conversa salva</div>'
                : chats.map(chat => `
                    <div class="history-item" onclick="loadChat('${chat.id}')">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="text-red-500 text-xs font-bold truncate">${chat.title}</div>
                                <div class="text-gray-600 text-[10px] mt-1">${new Date(chat.timestamp).toLocaleString('pt-BR')}</div>
                            </div>
                            <button onclick="deleteChat('${chat.id}', event)" class="text-red-900 hover:text-red-500 transition-colors flex-shrink-0" title="Apagar">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
        }

        function loadChat(chatId) {
            const chatData = JSON.parse(localStorage.getItem(chatId));
            if (!chatData) return;
            
            currentChatId = chatId;
            history = chatData.messages;
            
            const stream = document.getElementById('chat-stream');
            stream.innerHTML = '';
            document.getElementById('welcome').style.display = 'none';
            
            history.forEach(msg => {
                addMessage(msg.role, msg.content, false);
            });
            
            localStorage.setItem('nexus_last_chat', chatId);
            toggleHistory();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (confirm('Deseja realmente apagar esta conversa?')) {
                localStorage.removeItem(chatId);
                if (currentChatId === chatId) {
                    startNewChat();
                }
                loadHistoryList();
            }
        }

        // --- INPUT HANDLING ---
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- FILE HANDLING ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const maxSize = 1 * 1024 * 1024; // 1MB
            if (file.size > maxSize) {
                alert('Arquivo muito grande! Limite: 1MB.\nTamanho do arquivo: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
                return;
            }

            // Show progress
            document.getElementById('upload-progress').classList.remove('hidden');
            const progressBar = document.getElementById('upload-progress-bar');

            const reader = new FileReader();
            
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.style.width = percent + '%';
                }
            };

            reader.onload = (e) => {
                pendingFileContent = e.target.result;
                pendingFileName = file.name;
                
                // Hide progress
                setTimeout(() => {
                    document.getElementById('upload-progress').classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 300);
                
                // Show UI
                document.getElementById('upload-preview').classList.remove('hidden');
                document.getElementById('upload-preview').classList.add('flex');
                document.getElementById('filename-display').innerText = file.name;
                document.getElementById('filesize-display').innerText = '(' + (file.size / 1024).toFixed(1) + 'KB)';
                
                // Focus input
                document.getElementById('user-input').focus();
                document.getElementById('user-input').placeholder = `Arquivo carregado. Digite "Analise este código..."`;
            };

            reader.onerror = () => {
                alert('Erro ao carregar arquivo!');
                document.getElementById('upload-progress').classList.add('hidden');
                progressBar.style.width = '0%';
            };
            
            // Read file
            reader.readAsText(file);
        }

        function clearUpload() {
            pendingFileContent = null;
            pendingFileName = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('flex');
            document.getElementById('user-input').placeholder = "Enter command...";
        }

        // --- CHAT LOGIC ---
        function quickPrompt(txt) {
            document.getElementById('user-input').value = txt;
            sendMessage();
        }

        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            let text = inputEl.value.trim();
            
            if ((!text && !pendingFileContent) || !API_KEY) {
                if(!API_KEY) toggleSettings();
                return;
            }

            // Construct Message with File if present
            if (pendingFileContent) {
                // Send entire file even if large (up to 1MB)
                text = `${text}\n\n--- ARQUIVO ANEXADO: ${pendingFileName} ---\n\`\`\`\n${pendingFileContent}\n\`\`\`\n\n(Analise este código em busca de vulnerabilidades críticas)`;
                clearUpload();
            }

            // UI Updates
            inputEl.value = '';
            inputEl.style.height = 'auto';
            document.getElementById('welcome').style.display = 'none';
            
            addMessage('user', text);
            history.push({ role: "user", content: text });

            // Save after user message
            saveCurrentChat();

            // Loading state
            const loaderId = addLoader();

            try {
                const response = await fetch("https://router.huggingface.co/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: history,
                        max_tokens: 8192, // Increased for complete responses
                        temperature: 0.7,
                        stream: false
                    })
                });

                if (!response.ok) throw new Error("Connection Error");
                const data = await response.json();
                
                removeLoader(loaderId);
                const reply = data.choices[0].message.content;
                history.push({ role: "assistant", content: reply });
                addMessage('assistant', reply);

                // Save after assistant response
                saveCurrentChat();

            } catch (err) {
                removeLoader(loaderId);
                addMessage('system', "ERRO DE CONEXÃO: " + err.message);
            }
        }

        function addMessage(role, content, scroll = true) {
            const stream = document.getElementById('chat-stream');
            const div = document.createElement('div');
            
            if (role === 'user') {
                div.className = "message-user ml-auto max-w-[85%] md:max-w-[80%] bg-red-900/10 border border-red-900/50 p-3 md:p-4 text-gray-300 font-mono text-xs md:text-sm shadow-[0_0_10px_rgba(255,0,0,0.1)] break-words";
                div.innerHTML = `<span class="text-red-500 font-bold">>_</span> ${content.replace(/\n/g, '<br>')}`;
            } else if (role === 'system') {
                div.className = "w-full text-center text-red-600 text-xs uppercase font-bold border-y border-red-900/30 py-2";
                div.innerText = content;
            } else {
                div.className = "message-assistant w-full max-w-full space-y-4 pr-2";
                const parsed = marked.parse(content);
                div.innerHTML = `<div class="prose prose-invert prose-p:text-gray-400 prose-headings:text-red-500 prose-code:text-red-300 prose-pre:bg-gray-900 prose-pre:border-red-900 text-xs md:text-sm max-w-none break-words">${parsed}</div>`;
            }

            stream.appendChild(div);
            
            // Highlight Code Blocks
            div.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
                addCopyBtn(block);
            });

            if (scroll) {
                stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
            }
        }

        function addCopyBtn(block) {
            const pre = block.parentElement;
            const btn = document.createElement('button');
            btn.className = "absolute top-2 right-2 text-xs text-red-500 hover:text-white";
            btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
            btn.onclick = () => {
                navigator.clipboard.writeText(block.innerText);
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i>', 2000);
            };
            pre.style.position = 'relative';
            pre.appendChild(btn);
        }

        function addLoader() {
            const id = 'load-' + Date.now();
            const stream = document.getElementById('chat-stream');
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-center gap-2 p-3 md:p-4 text-red-500 text-xs font-mono";
            div.innerHTML = `<div class="hacker-loader"><span></span><span></span><span></span></div> DECRYPTING RESPONSE...`;
            stream.appendChild(div);
            stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function removeLoader(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // Handle fullscreen change events
        document.addEventListener('fullscreenchange', () => {
            isFullscreen = !!document.fullscreenElement;
        });
    </script>
</body>
</html>
